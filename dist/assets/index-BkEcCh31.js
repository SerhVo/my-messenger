import{i as $,g as O,a as q,G as z,c as F,b as _,s as B,d as G,e as K,f as W,y as H,r as i,P as g,o as V,j as e,h as Y,C as v,k as N,u as L,l as J,m as X,n as Q,p as Z,q as ee,t as se,v as R,w as te,x as re,z as ne,$ as ae,A as oe,B as ie,D as le,E as ce,L as de,F as ue}from"./vendor-DlUUW2eh.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const m of l.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&a(m)}).observe(document,{childList:!0,subtree:!0});function t(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function a(o){if(o.ep)return;o.ep=!0;const l=t(o);fetch(o.href,l)}})();const me={apiKey:"AIzaSyBhjdmCIe35zVHgwYoc_g3nLWukMpx46XE",authDomain:"my-messenger-c1484.firebaseapp.com",projectId:"my-messenger-c1484",storageBucket:"my-messenger-c1484.firebasestorage.app",messagingSenderId:"863897520682",appId:"1:863897520682:web:d0a0e360faf236f897d153"},E=$(me),c=O(E),w=q(E),pe=new z,he=()=>B(c,pe),S=F(w,"messages"),ge=_(E),y=(s,r="info")=>{H[r](s,{position:"top-right",autoClose:3e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,theme:"light"})},xe=async(s,r)=>{try{const t=await G(c,s,r);return y("Регистрация успешна!","success"),{user:t.user,error:null}}catch(t){return y(`Ошибка регистрации: ${t.message}`,"error"),{user:null,error:t.message}}},fe=async(s,r)=>{try{const t=await K(c,s,r);return y("Вход выполнен успешно!","success"),{user:t.user,error:null}}catch(t){return y(`Ошибка входа: ${t.message}`,"error"),{user:null,error:t.message}}},ye=async()=>{try{const s=await W(c);return y("Вы вошли анонимно!","success"),{user:s.user,error:null}}catch(s){return y(`Ошибка анонимного входа: ${s.message}`,"error"),{user:null,error:s.message}}},k=i.createContext(null),M=({children:s})=>{const[r,t]=i.useState(null);i.useEffect(()=>{const o=V(c,l=>{t(l)});return()=>o()},[]);const a=async()=>{await Y(c),t(null)};return e.jsx(k.Provider,{value:{user:r,signUp:xe,signIn:fe,signInAnon:ye,logout:a},children:s})};M.propTypes={children:g.node.isRequired};const U=()=>i.useContext(k),I="Mery",D=s=>v.AES.encrypt(s,I).toString(),A=s=>{try{return v.AES.decrypt(s,I).toString(v.enc.Utf8)}catch(r){return console.error("❌ Ошибка при расшифровке:",r),"Ошибка"}},be=async(s,r)=>{if(!c.currentUser)return;const t=N(w,"messages",s),a=r==null?void 0:r.includes(c.currentUser.uid);await L(t,{likes:a?J(c.currentUser.uid):X(c.currentUser.uid)})},je=async(s,r,t)=>{r.trim()&&(await L(N(w,"messages",s),{text:D(r)}),t(null))},we=async s=>{await Q(N(w,"messages",s))};function P({messages:s,loading:r,messagesEndRef:t}){const[a,o]=i.useState(null),[l,m]=i.useState(null),[u,h]=i.useState("");return e.jsxs("div",{className:"max-h-dvw overflow-auto border-b ",children:[r&&e.jsx("p",{children:"Загрузка сообщений..."}),s.map(n=>{var f,x,d,p,b,j,C;return e.jsxs(Z.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},className:`relative flex flex-col p-2 mb-1 rounded-md ${n.uid===((f=c.currentUser)==null?void 0:f.uid)?"bg-blue-100 border":"bg-green-100 border"}`,onMouseEnter:()=>o(n.id),onMouseLeave:()=>o(null),children:[e.jsxs("ul",{className:"flex items-center w-full",children:[e.jsxs("li",{className:" flex-none items-center max-w-40 overflow-hidden",children:[e.jsx("img",{src:n.photoURL||"/img/av_cat.jpg",alt:"User Avatar",className:"w-6 h-6  rounded-full mr-2 absolute transition-transform duration-200 hover:scale-200 hover:z-20"}),e.jsxs("p",{className:"text-xs font-bold text-blue-900 truncate max-w-[130px] ml-8",children:[((x=n.displayName)==null?void 0:x.slice(0,120))||"Аноним",n.uid===((d=c.currentUser)==null?void 0:d.uid)&&" (Вы)"]})]}),e.jsx("li",{className:"text-xs text-gray-500 grow ml-2",children:e.jsx("p",{children:new Date(n.createdAt.toDate()).toLocaleString("ru",{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric"})})}),e.jsx("li",{className:"flex gap-2 ml-3",children:e.jsxs("button",{onClick:()=>be(n.id,n.likes),className:"text-md ml-1",children:[(b=n.likes)!=null&&b.includes((p=c.currentUser)==null?void 0:p.uid)?"❤️":"🤍"," ",((j=n.likes)==null?void 0:j.length)??0]})})]}),l===n.id?e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsx("input",{type:"text",value:u,onChange:T=>h(T.target.value),className:"flex-1 p-1 border rounded-md"}),e.jsx("button",{onClick:()=>je(n.id,u,m),className:"text-green-600 hover:text-green-800",children:"✅"})]}):e.jsx("span",{className:"flex flex-wrap mt-1",dangerouslySetInnerHTML:{__html:ee.sanitize(se(A(n.text||"")))}}),n.uid===((C=c.currentUser)==null?void 0:C.uid)&&a===n.id&&e.jsxs("div",{className:"absolute top-2 right-11 flex gap-2",children:[e.jsx("button",{onClick:()=>{m(n.id),h(A(n.text||""))},className:"text-gray-600 hover:text-blue-600 transition",children:"🖊️"}),e.jsx("button",{onClick:()=>we(n.id),className:"text-gray-600 hover:text-red-600 transition",children:"🗑"})]})]},n.id)}),s.length===0&&e.jsx("p",{children:"Нет сообщений. Придумайте что-нибудь новое!"}),e.jsx("div",{ref:t})]})}P.propTypes={messages:g.arrayOf(g.shape({id:g.string.isRequired,text:g.string.isRequired,uid:g.string.isRequired,displayName:g.string,photoURL:g.string,likes:g.arrayOf(g.string)})).isRequired,loading:g.bool.isRequired,messagesEndRef:g.object.isRequired};const ve=async(s,r,t)=>{if(!(!c.currentUser||s.trim().length<1||s.trim().length>500))try{const a=D(s);await R(S,{text:a,uid:c.currentUser.uid,displayName:c.currentUser.displayName||"Аноним",photoURL:c.currentUser.photoURL,createdAt:new Date,likes:[]}),r(""),t(!1)}catch(a){console.error("Ошибка при отправке сообщения:",a)}},Ne=async(s,r)=>{if(s)try{const t=te(ge,`images/${s.name}`);await re(t,s);const a=await ne(t);await R(S,{imageUrl:a,uid:c.currentUser.uid,displayName:c.currentUser.displayName||"Аноним",photoURL:c.currentUser.photoURL,createdAt:new Date,likes:[]}),r("")}catch(t){console.error("Ошибка при загрузке файла:",t)}};function Ee(){const[s,r]=i.useState(""),[t,a]=i.useState(!1),[o,l]=i.useState(!1),{user:m}=U(),u=i.useRef(null),h=i.useCallback(()=>{a(!0),setTimeout(()=>a(!1),2e3)},[]),n=i.useCallback(()=>{s.trim()&&ve(s,r,a)},[s]),f=d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),n())},x=async d=>{const p=d.target.files[0];await Ne(p,r)};return i.useEffect(()=>{const d=p=>{u.current&&!u.current.contains(p.target)&&l(!1)};return document.addEventListener("mousedown",d),()=>document.removeEventListener("mousedown",d)},[]),e.jsx(e.Fragment,{children:e.jsxs("div",{className:"relative",children:[t&&e.jsxs("p",{className:"absolute top-[-20px] left-0 text-sm text-gray-500",children:["Печатает ",(m==null?void 0:m.displayName)||"Аноним","..."]}),e.jsxs("div",{className:"flex justify-between items-center mt-5",children:[o&&e.jsx("div",{ref:u,className:"absolute bottom-12 left-0 z-50",children:e.jsx(ae,{onEmojiSelect:d=>r(s+d.native)})}),e.jsx("input",{value:s,onChange:d=>{r(d.target.value),h()},onKeyDown:f,className:"w-full p-1 border rounded-md",placeholder:"Введите сообщение..."}),e.jsx("button",{onClick:n,className:"ml-2 p-2 bg-sky-500 text-white rounded-md",children:"Отправить"}),e.jsx("button",{className:"ml-2 cursor-pointer text-3xl",onClick:()=>l(!o),children:"😊"}),e.jsx("input",{type:"file",onChange:x,className:"hidden",id:"fileUpload"}),e.jsx("label",{htmlFor:"fileUpload",className:"cursor-pointer ml-2 text-3xl",children:"📷"})]})]})})}function Se(){const[s,r]=i.useReducer((u,h)=>{switch(h.type){case"SET_MESSAGES":return h.payload;case"ADD_MESSAGE":return[...u,h.payload];default:return u}},[]),[t,a]=i.useState(20),[o,l]=i.useState(!0),m=i.useRef(null);return i.useEffect(()=>{l(!0);const u=oe(S,le("createdAt","desc"),ie(t)),h=ce(u,n=>{const f=n.docs.map(x=>({id:x.id,...x.data()}));r({type:"SET_MESSAGES",payload:f.reverse()}),l(!1)});return()=>h()},[t]),i.useEffect(()=>{s.length>0&&setTimeout(()=>{var u;(u=m.current)==null||u.scrollIntoView({behavior:"smooth"})},100)},[s]),e.jsxs("div",{className:"relative w-full max-w-md p-4 border rounded-md",children:[e.jsx("div",{className:"absolute inset-0 bg-[url('/img/fon.png')] bg-contain bg-repeat opacity-10"}),e.jsxs("div",{className:"relative z-10",children:[e.jsx(P,{messages:s,loading:o,messagesEndRef:m}),e.jsx(Ee,{messagesEndRef:m}),e.jsx("button",{onClick:()=>a(u=>u+20),className:"p-2 bg-gray-200 rounded-md mt-2",children:"Загрузить больше"})]})]})}function Ue(){const{signUp:s,signIn:r,signInAnon:t}=U(),[a,o]=i.useState(""),[l,m]=i.useState(""),[u,h]=i.useState(null),[n,f]=i.useState(!1),x=i.useRef(null);i.useEffect(()=>{var p;(p=x.current)==null||p.focus()},[]);const d=async(p,...b)=>{f(!0),h(null);try{await p(...b)}catch(j){h(j.message||"Ошибка входа")}f(!1)};return e.jsxs("div",{className:"flex flex-col items-center p-4",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Вход в чат"}),u&&e.jsx("p",{className:"text-red-500 mb-2",children:u}),e.jsx("input",{type:"email",ref:x,placeholder:"E-mail",value:a,onChange:p=>o(p.target.value),className:"p-2 border rounded-md mb-2 w-60",disabled:n}),e.jsx("input",{type:"password",placeholder:"Пароль",value:l,onChange:p=>m(p.target.value),className:"p-2 border rounded-md mb-2 w-60",disabled:n}),e.jsx("button",{onClick:()=>d(r,a,l),className:`bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-md w-60 mb-2 ${n?"opacity-50 cursor-not-allowed":""}`,disabled:!a||!l||n,children:n?"Вход...":"Войти"}),e.jsx("button",{onClick:()=>d(s,a,l),className:`bg-green-500 hover:bg-green-600 text-white p-2 rounded-md w-60 mb-2 ${n?"opacity-50 cursor-not-allowed":""}`,disabled:!a||!l||n,children:n?"Регистрация...":"Зарегистрироваться"}),e.jsx("button",{className:`text-white bg-yellow-400 p-2 rounded-md w-60 mb-2 hover:bg-yellow-600 ${n?"opacity-50 cursor-not-allowed":""}`,onClick:()=>d(he),disabled:n,children:"Войти через Google"}),e.jsx("button",{onClick:()=>d(t),className:`bg-gray-500 hover:bg-gray-600 text-white p-2 rounded-md w-60 ${n?"opacity-50 cursor-not-allowed":""}`,disabled:n,children:"Войти анонимно"})]})}function Ce(){const{user:s,logout:r}=U(),[t,a]=i.useState(s);i.useEffect(()=>{a(s)},[s]);const o=async()=>{await r(),a(null)};return e.jsxs("div",{className:"flex flex-col items-center p-4",children:[e.jsx("img",{src:"/img/logo.png",alt:"logo",className:"w-20 h-20 p-2 object-fit "}),e.jsx("h1",{className:"text-2xl font-bold",children:"Chat App"}),t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-center p-1",children:[t.photoURL?e.jsx("img",{src:t.photoURL,alt:"User Avatar",className:"w-10 h-10 rounded-full transition-transform duration-200 hover:scale-200 hover:z-20"}):e.jsx("img",{src:"/img/av_bird2.jpg",alt:"Default Avatar",className:"w-10 h-10 rounded-full transition-transform duration-200 hover:scale-200 hover:z-20"}),e.jsxs("p",{className:"text-sm text-gray-500 ml-10",children:["Привет, ",t.displayName||"Аноним","!"]}),e.jsx("button",{onClick:o,className:"m-2 p-1 bg-gray-200 hover:bg-gray-500 text-sm hover:text-white rounded-md",children:"Выйти"})]}),e.jsx(Se,{})]}):e.jsx(Ue,{})]})}function Ae(){return e.jsxs(e.Fragment,{children:[e.jsx(M,{children:e.jsx(Ce,{})}),e.jsx(de,{})]})}ue.createRoot(document.getElementById("root")).render(e.jsx(i.StrictMode,{children:e.jsx(Ae,{})}));
